version: '3.8'

services:
  # ------------------------------------
  # 1. FastAPI Game Engine
  # (Game Logic + AI + Ads)
  # ------------------------------------
  loop-backend:
    build:
      context: ./loop-backend
      dockerfile: Dockerfile
    env_file:
      - ./loop-backend/.env
    ports:
      - "8000:8000"
    volumes:
      - ./loop-backend:/app # Mount source code for hot-reloading
    depends_on:
      db:
        condition: service_healthy # Waits for Postgres to be ready
    networks:
      - loopin_net
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # ------------------------------------
  # 2. Node.js Web3 Manager
  # (Secure Treasury)
  # ------------------------------------
  web3-manager:
    build:
      context: ./web3-manager
      dockerfile: Dockerfile
    env_file:
      - ./web3-manager/.env
    ports:
      - "3001:3001" # Expose for internal communication
    volumes:
      - ./web3-manager:/app # Mount source code for hot-reloading
    networks:
      - loopin_net
    command: npm run dev # Or your start command

  # ------------------------------------
  # 3. PostGIS Database
  # (Geospatial State Archive)
  # ------------------------------------
  db:
    image: postgis/postgis:15-3.4 # Official PostGIS image
    env_file:
      - ./postgres.env # Separate .env for DB credentials
    ports:
      - "5432:5432"
    volumes:
      - loopin_db_data:/var/lib/postgresql/data
    healthcheck:
      # Tests if Postgres is ready to accept connections
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - loopin_net

networks:
  loopin_net:
    driver: bridge

volumes:
  loopin_db_data:
    driver: local